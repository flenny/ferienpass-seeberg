<script>
  const POLL_INTERVAL = 10000
  const EVENTS_CONTAINER_ELEMENT_ID = 'events'
  let eventData

  const refreshEvents = () => {
    google.script.run.withSuccessHandler(events => {
      eventData = Object.values(events)
      updateEvents(eventData)
      setTimeout(refreshEvents, POLL_INTERVAL)
    }).getEvents()
  }

  const populateData = () => {
    google.script.run.withSuccessHandler(events => {
      const container = document.getElementById(EVENTS_CONTAINER_ELEMENT_ID)
      while (container.hasChildNodes()) container.removeChild(container.lastChild)
      eventData = Object.values(events)
      eventData.forEach(event => addEventToForm(event))
    }).getEvents()
  }

  const updateEvents = events => {
    events.forEach(event => {
      const [id] = event
      const container = document.getElementById(`event-${id}-status`)
      if (container) container.innerHTML = getEventStatus(event)
      else addEventToForm(event)
    })
  }

  const getEventStatus = event => {
    const [id, , , , , , , , , , participantLimit, bookings, availableSeats] = event
    let [badgeState, badgeText] = ['success', 'freie Pl√§tze']
    if (availableSeats <= 0) [badgeState, badgeText] = ['danger', 'Warteliste']
    else if (availableSeats <= 5) [badgeState, badgeText] = ['warning', 'wenige Pl√§tze']
    return `
    <br class="d-none d-md-block">
    <p>
      <small class="d-none d-lg-block">
        <i class="bi-people-fill"></i>&ensp;Anzahl Pl√§tze: ${participantLimit}<br>
        <i class="bi-pencil-square"></i>&ensp;Anmeldungen: ${bookings}<br>
        <i class="bi-check2-square"></i>&ensp;Freie Pl√§tze: ${availableSeats}
      </small>
      <span class="badge text-bg-${badgeState} bg-${badgeState}">${badgeText}</span>
    </p>
  `
  }

  const addEventToForm = event => {
    const [id, name, description, , costs, additionalCosts, start, end, gradeFrom, gradeTo, participantLimit, , availableSeats] = event
    const events = document.getElementById(EVENTS_CONTAINER_ELEMENT_ID)

    // Create a string to display the costs of the event
    let costsDisplaySring = ''
    if (costs + additionalCosts <= 0) costsDisplaySring = 'gratis'
    else if (additionalCosts === 0) costsDisplaySring = `${costs} CHF`
    else costsDisplaySring = `${costs} CHF (+ ${additionalCosts} CHF)`

    const weekday = new Date(start).toLocaleDateString('de-CH', { weekday: 'long' })
    const date = new Date(start).toLocaleDateString('de-CH', { day: 'numeric', month: 'long' })
    const from = new Date(start).toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' })
    const to = new Date(end).toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' })

    // Create meta data which is used to filter the events by grade
    const gradeMetaData = []
    for (let i = gradeFrom; i <= gradeTo; i++) gradeMetaData.push(`grade-${i}`)

    const result = `
    <tr>
      <td>
        <input id="event-${id}-input" class="fa-checkbox-square" type="checkbox" name="eventId" value="${id}">
      </td>
      <td>${id}</td>
      <td>
        <label for="event-${id}-input">${name}</label>
        <p class="d-none d-md-block"><small>${description}</small></p>
      </td>
      <td>
        <br class="d-none d-md-block">
        <div id="event-${id}-details">
          <p style="white-space: nowrap;" data-search-meta="${gradeMetaData.join(' ')}"><small>
            <i class="bi-calendar"></i>&ensp;${weekday}, ${date}<br>
            <i class="bi-clock"></i>&ensp;${from} - ${to} Uhr<br>
            <i class="bi-tencent-qq"></i>&ensp;${gradeFrom}.-${gradeTo}. Klasse<br>
            <i class="bi-piggy-bank"></i>&ensp;${costsDisplaySring}</small>
          </p>
        </div>
      </td>
      <td>
        <div id="event-${id}-status">
          ${getEventStatus(event)}
        </div>
      </td>
    </tr>
  `
    events.insertAdjacentHTML('beforeend', result)
  }

  const alertArea = document.getElementById('alertArea')
  const clearAlert = id => document.getElementById(`alert-${id}`)?.remove()
  const clearAllAlerts = () => alertArea.innerHTML = ''
  const alert = async (type, head, body) => {
    const id = Date.now()
    const wrapper = document.createElement('div')
    wrapper.id = `alert-${id}`
    wrapper.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show">
        <h4 class="alert-heading">${head}</h4>
        <p>${body}</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `
    alertArea.append(wrapper)

    // Wait 15 seconds before clearing the alert
    await new Promise(r => setTimeout(r, 15000));
    clearAlert(id)
  }

  $("#search-reset-btn").click(function () {
    document.getElementById('search').value = ''
    $("#events tr").filter(function () { $(this).toggle(true) });
    $(this).prop('disabled', true)
  })

  $("#search").on("input propertychange paste", function () {
    var words = $(this).val().toLowerCase().trim().split(' ').filter(e => String(e).trim());
    const resetBtn = document.getElementById('search-reset-btn')
    resetBtn.disabled = true
    if (words.length > 0) {
      resetBtn.disabled = false
    }

    $("#events tr").filter(function () {
      const searchText = $(this).text().toLowerCase()
      $(this).toggle(words.every(word => searchText.indexOf(word) > -1))
    });
  })

  form.onsubmit = async e => {
    e.preventDefault()
    e.stopPropagation()
    clearAllAlerts()

    // Check for at least one event
    if (!new FormData(form).has('eventId')) {
      alert('warning', 'Unvollst√§ndige Anmeldung', 'Bitte w√§hle mindestens einen (1) Kurs aus. Es sollte f√ºr jeden und jede etwas spannendes dabei sein.')
      return
    }

    let valid = true
    const selectedEvents = [...new FormData(form).getAll('eventId')]

    // Validate if selected events match the selected grade
    const selectedGrade = document.getElementById('grade').value
    const nonMatchingEvents = []
    selectedEvents.forEach(id => {
      const eventMetaData = document.getElementById(`event-${id}-details`).outerHTML
      !eventMetaData.includes(`grade-${selectedGrade}`) && nonMatchingEvents.push(id)
    })
    if (nonMatchingEvents.length > 0) {
      alert('warning', 'Ung√ºltige Kurse', `Bitte w√§hle nur Kurse aus, die f√ºr die ${selectedGrade}. Klasse bestimmt sind. Du hast folgende Kurse ausgew√§hlt, die nicht f√ºr die ${selectedGrade}. Klasse sind: ${nonMatchingEvents.join(', ')}`)
      valid = false
    }

    // Validate if selected events do not overlap in time
    const overlappingEvents = []
    selectedEvents.forEach(eventId1 => {
      const [, , , , , , start, end] = eventData.find(e => e[0] == eventId1)
      const event1Start = new Date(start)
      const event1End = new Date(end)
      selectedEvents.forEach(eventId2 => {
        if (eventId1 === eventId2) return
        const [, , , , , , start, end] = eventData.find(e => e[0] == eventId2)
        const event2Start = new Date(start)
        const event2End = new Date(end)
        if (event1Start < event2End && event1End > event2Start) overlappingEvents.push(eventId1)
      })
    })
    if (overlappingEvents.length > 0) {
      alert('warning', '√úberlappende Kurse', `Bitte w√§hle nur Kurse aus, die nicht zeitgleich stattfinden. Du hast folgende Kurse ausgew√§hlt, die zeitgleich stattfinden: ${overlappingEvents.join(', ')}`)
      valid = false
    }

    if (!valid) return

    const modalDialogSend = new bootstrap.Modal('#modal-send')
    const modalDialogSuccess = new bootstrap.Modal('#modal-success')

    if (form.checkValidity()) {
      modalDialogSend.show()
      google.script.run
        .withFailureHandler(error => {
          modalDialogSend.hide()
          alert('danger', 'Oh nein! Ein Fehler üôà', 'Beim Speichern deiner Daten ist leider ein Fehler aufgetreten. Versuche es bitte nochmals und melde dich bei mir (E-Mail ist unten verlinkt), falls es weiterhin nicht funktioniert.')
          console.log(error)
        })
        .withSuccessHandler(async redirectUrl => {
          try {
            window.top.location.href = redirectUrl;
          }
          catch (error) { console.log(error) }
          finally {
            await new Promise(r => setTimeout(r, 1000));
            document.getElementById('btn-success-redirect').href = redirectUrl
            modalDialogSend.hide()
            modalDialogSuccess.show()
          }
        })
        .processForm([...new FormData(form).entries()])
    }
    else {
      alert('warning', 'Fehlende Angaben in der Anmeldung', 'Es fehlen noch Angaben in der Anmeldung. Bitte √ºberpr√ºfe deine Angaben und versuche es erneut.')
      form.classList.add('was-validated')
    }
  }

  populateData()
  setTimeout(refreshEvents, POLL_INTERVAL);

  const bookingId = document.getElementById('bookingId').value
  if (bookingId) {
    google.script.run
      .withSuccessHandler(bookings => {
        const booking = Object.values(bookings).pop()
        const [, , email, , , phone, address, zip, city] = booking
        document.getElementById('email').value = email
        document.getElementById('phone').value = phone
        document.getElementById('address').value = address
        document.getElementById('zip').value = zip
        document.getElementById('city').value = city
      })
      .getBookings(bookingId)
  }

</script>
